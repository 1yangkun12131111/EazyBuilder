(this.webpackJsonp=this.webpackJsonp||[]).push([[393],{223:function(t,s,e){e("HVBj"),e("gjpc"),e("xsb7"),t.exports=e("lPmm")},lPmm:function(t,s,e){"use strict";e.r(s);e("S26F");var o=e("Tmea"),n=e.n(o),r=e("EmJ/"),i=e.n(r),h=e("XRO8"),d=e("2ibD"),a=e("/lV4"),c=e("nc9B"),p=(e("pBsb"),e("G3fq")),l=e.n(p),u=e("NmEs"),f={PASSWORD:"password",SSH:"ssh_public_key"};class ${constructor(t){this.backOffRequestCounter=0,this.$form=i()(t),this.$repositoryUrl=this.$form.find(".js-repo-url"),this.$knownHosts=this.$form.find(".js-known-hosts"),this.$sectionSSHHostKeys=this.$form.find(".js-ssh-host-keys-section"),this.$hostKeysInformation=this.$form.find(".js-fingerprint-ssh-info"),this.$btnDetectHostKeys=this.$form.find(".js-detect-host-keys"),this.$btnSSHHostsShowAdvanced=this.$form.find(".btn-show-advanced"),this.$dropdownAuthType=this.$form.find(".js-mirror-auth-type"),this.$hiddenAuthType=this.$form.find(".js-hidden-mirror-auth-type"),this.$wellPasswordAuth=this.$form.find(".js-well-password-auth")}init(){var t=this;this.handleRepositoryUrlInput(!0),this.$repositoryUrl.on("keyup",(function(){return t.handleRepositoryUrlInput()})),this.$knownHosts.on("keyup",(function(s){return t.handleSSHKnownHostsInput(s)})),this.$dropdownAuthType.on("change",(function(s){return t.handleAuthTypeChange(s)})),this.$btnDetectHostKeys.on("click",(function(s){return t.handleDetectHostKeys(s)})),this.$btnSSHHostsShowAdvanced.on("click",(function(s){return t.handleSSHHostsAdvanced(s)}))}handleRepositoryUrlInput(t){const s=this.$repositoryUrl.val().split("://")[0],e=/http|git/;if(t||this.$form.get(0).checkValidity()){const o="ssh"===s;this.$sectionSSHHostKeys.collapse(o?"show":"hide"),this.$btnDetectHostKeys.enable();const n=e.test(s);this.$dropdownAuthType.attr("disabled",n),t&&o?(this.$dropdownAuthType.val(f.SSH),this.toggleAuthWell(f.SSH)):(this.$dropdownAuthType.val(f.PASSWORD),this.toggleAuthWell(f.PASSWORD))}}handleDetectHostKeys(){var t=this;const s=this.$form.data("project-mirror-ssh-endpoint"),e=this.$repositoryUrl.val(),o=this.$knownHosts.val(),n=this.$btnDetectHostKeys.find(".js-spinner");this.$btnDetectHostKeys.disable(),n.removeClass("d-none"),Object(u.d)((function(n,r){d.a.get("".concat(s,"?ssh_url=").concat(e,"&compare_host_keys=").concat(encodeURIComponent(o))).then((function(s){let{data:e,status:o}=s;204===o?(t.backOffRequestCounter+=1,t.backOffRequestCounter<3?n():r(e)):r(e)})).catch(r)})).then((function(s){n.addClass("d-none"),t.$hostKeysInformation.find(".js-fingerprint-verification").collapse(s.host_keys_changed?"hide":"show"),s.known_hosts&&s.fingerprints&&t.showSSHInformation(s)})).catch((function(s){let{response:e}=s;const o=e.data?e.data.message:Object(a.a)("An error occurred while detecting host keys");Object(h.c)(o),n.addClass("hidden"),t.$btnDetectHostKeys.enable()}))}handleSSHKnownHostsInput(){this.$hostKeysInformation.find(".js-fingerprints-list").addClass("invalidate"),this.$hostKeysInformation.find(".js-fingerprint-verification").collapse("hide")}handleSSHHostsAdvanced(){const t=this.$sectionSSHHostKeys.find(".js-ssh-known-hosts"),s=t.hasClass("show");t.collapse("toggle"),this.$btnSSHHostsShowAdvanced.toggleClass("show-advanced",s)}handleAuthTypeChange(){const t=this.$dropdownAuthType.val();this.$wellPasswordAuth.collapse("hide"),this.updateHiddenAuthType(t),this.toggleAuthWell(t)}showSSHInformation(t){const s=this.$hostKeysInformation.find(".js-fingerprints-list");let e="";t.fingerprints.forEach((function(t){const s=l()(t.fingerprint);e+="<code>".concat(s,"</code>")})),this.$hostKeysInformation.collapse("show"),s.removeClass("invalidate"),s.html(e),this.$sectionSSHHostKeys.find(".js-known-hosts").val(t.known_hosts)}toggleAuthWell(t){this.$wellPasswordAuth.collapse(t===f.PASSWORD?"show":"hide"),this.updateHiddenAuthType(t)}updateHiddenAuthType(t){this.$hiddenAuthType.val(t),this.$hiddenAuthType.prop("disabled",t===f.SSH)}destroy(){this.$repositoryUrl.off("keyup"),this.$form.find(".js-known-hosts").off("keyup"),this.$dropdownAuthType.off("change"),this.$btnDetectHostKeys.off("click"),this.$btnSSHHostsShowAdvanced.off("click")}}class m{constructor(t){this.$container=i()(t),this.$password=null,this.$form=i()(".js-mirror-form",this.$container),this.$urlInput=i()(".js-mirror-url",this.$form),this.$protectedBranchesInput=i()(".js-mirror-protected",this.$form),this.$table=i()(".js-mirrors-table-body",this.$container),this.mirrorEndpoint=this.$form.data("projectMirrorEndpoint")}init(){this.initMirrorPush(),this.registerUpdateListeners()}initMirrorPush(){var t=this;this.$keepDivergentRefsInput=i()(".js-mirror-keep-divergent-refs",this.$form),this.$passwordGroup=i()(".js-password-group",this.$container),this.$password=i()(".js-password",this.$passwordGroup),this.$authMethod=i()(".js-auth-method",this.$form),this.$keepDivergentRefsInput.on("change",(function(){return t.updateKeepDivergentRefs()})),this.$authMethod.on("change",(function(){return t.togglePassword()})),this.$password.on("input.updateUrl",(function(){return t.debouncedUpdateUrl()})),this.initMirrorSSH(),this.updateProtectedBranches(),this.updateKeepDivergentRefs()}initMirrorSSH(){this.$password&&this.$password.off("input.updateUrl"),this.$password=void 0,this.sshMirror=new $(".js-mirror-form"),this.sshMirror.init()}updateUrl(){let t=this.$urlInput.val();if(this.$password){const s=this.$password.val();s&&(t=t.replace("@",":".concat(s,"@")))}i()(".js-mirror-url-hidden",this.$form).val(t)}updateProtectedBranches(){const t=this.$protectedBranchesInput.get(0).checked?this.$protectedBranchesInput.val():"0";i()(".js-mirror-protected-hidden",this.$form).val(t)}updateKeepDivergentRefs(){const t=this.$keepDivergentRefsInput.get(0);if(t){const s=t.checked?this.$keepDivergentRefsInput.val():"0";i()(".js-mirror-keep-divergent-refs-hidden",this.$form).val(s)}}registerUpdateListeners(){var t=this;this.debouncedUpdateUrl=n()((function(){return t.updateUrl()}),200),this.$urlInput.on("input",(function(){return t.debouncedUpdateUrl()})),this.$protectedBranchesInput.on("change",(function(){return t.updateProtectedBranches()})),this.$table.on("click",".js-delete-mirror",(function(s){return t.deleteMirror(s)}))}togglePassword(){const t="password"===this.$authMethod.val();t||(this.$password.val(""),this.updateUrl()),this.$passwordGroup.collapse(t?"show":"hide")}deleteMirror(t,s){var e=this;const o=i()(t.currentTarget);let n=s;return n||(n={project:{remote_mirrors_attributes:{id:o.data("mirrorId"),_destroy:1}}}),d.a.put(this.mirrorEndpoint,n).then((function(){return e.removeRow(o)})).catch((function(){return Object(h.c)(Object(a.a)("Failed to remove mirror."))}))}removeRow(t){const s=t.closest("tr");Object(c.d)(i()(".js-delete-mirror",s)),s.remove()}}var w=e("1jeo");document.addEventListener("DOMContentLoaded",(function(){Object(w.a)();const t=document.querySelector(".js-mirror-settings");t&&new m(t).init()}))}},[[223,1,0,2,3,4,5,15,49,125]]]);
//# sourceMappingURL=pages.projects.settings.repository.show.6ab5f2ab.chunk.js.map